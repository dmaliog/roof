<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Калькулятор расхода кровельных материалов</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    h2 {
      color: #2c3e50 !important;
      margin-bottom: 25px !important;
      font-weight: 600 !important;
      letter-spacing: 0.5px !important;
      font-size: 20px !important;
      position: relative !important;
      padding-bottom: 10px !important;
    }
    h2::after {
      content: '';
      position: absolute !important;
      bottom: 0 !important;
      left: 0 !important;
      width: 50px !important;
      height: 3px !important;
      background: #3498db !important;
      border-radius: 2px !important;
    }
    body {
      font-family: 'Open Sans', sans-serif;
      background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
      margin: 0;
      padding: 40px;
      color: #2c3e50;
      line-height: 1.6;
      overflow-x: hidden;
    }
    select {
        width: 100%;
        padding: 12px 30px 12px 12px;
        border: 1px solid #d1d5db; /* border-gray-300 */
        border-radius: 8px;
        background: #f9fafb; /* bg-gray-50 */
        font-size: 16px;
        color: #2c3e50; /* text-gray-900 */
        appearance: none; /* Убираем стандартную стрелку */
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%232c3e50' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px;
        transition: border-color 0.3s, box-shadow 0.3s;
    }
    select:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-100 flex items-center justify-center min-h-screen p-4">
  <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-3xl fade-in">
    <h2>Калькулятор кровельных рулонов</h2>

    <div class="grid md:grid-cols-2 gap-6">
      <div>
        <label for="area" class="block text-sm font-semibold text-gray-800 mb-2">Площадь кровли (м²)</label>
        <input type="number" id="area" class="mt-1 p-3 w-full border border-gray-300 rounded-lg bg-gray-50 text-gray-900 placeholder-gray-400" placeholder="Введите площадь" step="0.01" min="0">
      </div>

      <div>
        <label for="material" class="block text-sm font-semibold text-gray-800 mb-2">Выберите материал</label>
        <select id="material" class="w-full p-3 rounded-lg border border-gray-300 bg-gray-50">
          <option value="technoelast-k-tkp.pdf">Техноэласт К ТКП, 10x1 м</option>
          <option value="technoelast-p-tpp.pdf">Техноэласт П ТПП, 10x1 м</option>
          <option value="technoelast-p-epp.pdf">Техноэласт П ЭПП, 10x1 м</option>
          <option value="technoelast-k-ekp.pdf">Техноэласт К ЭКП, 10x1 м</option>
          <option value="technoelast-p-hpp.pdf">Техноэласт П ХПП, 10x1 м</option>
          <option value="technoelast-termo-p-epp.pdf">Техноэласт ТЕРМО П ЭПП, 10x1 м</option>
          <option value="technoelast-termo-k-ekp.pdf">Техноэласт ТЕРМО К ЭКП, 10x1 м</option>
          <option value="technoelast-green-p-epp.pdf">Техноэласт ГРИН П ЭПП, 10x1 м</option>
          <option value="technoelast-green-k-ekp.pdf">Техноэласт ГРИН К ЭКП, 10x1 м</option>
          <option value="technoelast-barer-lite.pdf">Техноэласт БАРЬЕР ЛАЙТ, 20х1 м</option>
          <option value="technoelast-dekor-ekp.pdf">Техноэласт Декор К ЭКП, 10х1 м</option>
          <option value="technoelast-vent-k-ekv.pdf">Техноэласт ВЕНТ К ЭКВ, 8х1 м</option>
          <option value="technoelast-vent-p-epv.pdf">Техноэласт ВЕНТ П ЭПВ, 8х1 м</option>
          <option value="technoelast-solo-rp1-ekp.pdf">Техноэласт СОЛО РП1 ЭКП, 8х1 м</option>
          <option value="technoelast-plamya-stop-ekp.pdf">Техноэласт ПЛАМЯ СТОП ЭКП, 10х1 м</option>
          <option value="technoelast-emp.pdf">Техноэласт ЭМП, 10х1 м</option>
          <option value="uniflex-k-ekp.pdf">Унифлекс К ЭКП, 10х1 м</option>
          <option value="uniflex-p-epp.pdf">Унифлекс П ЭПП, 10х1 м</option>
          <option value="uniflex-k-tkp.pdf">Унифлекс К ТКП, 10х1 м</option>
          <option value="uniflex-express-emp.pdf">Унифлекс ЭКСПРЕСС ЭМП, 10х1 м</option>
          <option value="uniflex-k-hkp.pdf">Унифлекс К ХКП, 10х1 м</option>
          <option value="uniflex-p-hpp.pdf">Унифлекс П ХПП, 10х1 м</option>
          <option value="stekloizon-k-tkp.pdf">Стеклоизол К ТКП, 10х1 м</option>
          <option value="stekloizon-r-tkp.pdf">Стеклоизол Р ТПП/ХПП/ХМП/ТКП/ХКП, 9x1 м</option>
          <option value="bikrost-k-hkp.pdf">Бикрост К ХКП, 10x1 м</option>
          <option value="bikrost-k-tkp.pdf">Бикрост К ТКП, 10х1 м</option>
          <option value="bikrost-p-epp.pdf">Бикрост П ЭПП, 15х1 м</option>
          <option value="linkrom-rem-tkp.pdf">Линокром РЕМ ТКП, 8x1 м</option>
          <option value="linkrom-p-epp.pdf">Линокром П ЭПП, 15х1 м</option>
          <option value="linkrom-p-tpp.pdf">Линокром П ТПП, 15х1 м</option>
          <option value="linkrom-k-hkp.pdf">Линокром К ХКП, 10x1 м</option>
          <option value="bikroelast-k-ekp.pdf">Бикроэласт К ЭКП, 10х1 м</option>
          <option value="bikroelast-p-epp.pdf">Бикроэласт П ЭПП, 15х1 м</option>
          <option value="bikroelast-k-tkp.pdf">Бикроэласт К ТКП, 10х1 м</option>
          <option value="bikroelast-p-tpp.pdf">Бикроэласт П ТПП, 15х1 м</option>
          <option value="bikroelast-k-hkp.pdf">Бикроэласт К ХКП, 10х1 м</option>
          <option value="bikroelast-p-hpp.pdf">Бикроэласт П ХПП, 15х1 м</option>
          <option value="ekoflex-ekp.pdf">Экофлекс ЭПП/ЭКП/ХКП, 10х1 м</option>
          <option value="bipol-ekp.pdf">Биполь К ЭКП, 10х1 м</option>
          <option value="bipol-epp.pdf">Биполь П ЭПП, 15х1 м</option>
          <option value="bipol-tkp.pdf">Биполь К ТКП, 10х1 м</option>
          <option value="bipol-tpp.pdf">Биполь П ТПП, 15х1 м</option>
          <option value="bipol-hpp.pdf">Биполь П ХПП, 15х1 м</option>
          <option value="technobarer.pdf">ТЕХНОБАРЬЕР, 10x1 м</option>
          <option value="uniflex-s-sms.pdf">Унифлекс С ЭМС, 15x1 м</option>
          <option value="parob-sa500.pdf">Паробарьер СА 500, 50х1,08 м</option>
          <option value="parob-sf1000.pdf">Паробарьер СФ 1000, 30x1,08 м</option>

        </select>
      </div>
    </div>

    <div class="mt-6 flex flex-col md:flex-row gap-4">
      <button onclick="calculate()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-3 rounded-lg font-semibold hover:from-blue-700 hover:to-indigo-700 transition-all duration-300">Рассчитать</button>
      <button onclick="renderPDF()" class="w-full bg-gray-200 text-gray-700 p-3 rounded-lg font-semibold hover:bg-gray-300 transition-all duration-300">Показать PDF</button>
    </div>

    <div id="result" class="mt-6 text-center"></div>

    <div class="mt-6">
      <canvas id="pdf-canvas" class="rounded shadow hidden border w-full h-auto max-w-full"></canvas>

      <div id="pdf-controls" class="mt-4 hidden flex justify-between items-center gap-4">
        <button onclick="prevPage()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">← Назад</button>
        <span class="text-sm text-gray-700">Страница <span id="page-num">1</span> из <span id="page-count">1</span></span>
        <button onclick="nextPage()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">Вперёд →</button>
      </div>
    </div>
  </div>

  <script>
    let pdfDoc = null;
    let currentPage = 1;
    let totalPages = 0;

    async function fetchPDFText(url) {
      const pdf = await pdfjsLib.getDocument(url).promise;
      let fullText = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        content.items.forEach(item => fullText += item.str + ' ');
      }
      return fullText;
    }

    function extractRollArea(text) {
    const simplified = text.replace(/\s+/g, ' ').toLowerCase();

    const lengthMatch = simplified.match(/длина[^0-9]*?±?\d*%{0,1}\s*(\d+[,.]?\s*\d*)/i);
    const widthMatch = simplified.match(/ширина[^0-9]*?±?\d*%{0,1}\s*(\d+[,.]?\s*\d*)/i);

    if (lengthMatch && widthMatch) {
        const normalize = str => str.replace(/\s+/g, '').replace(',', '.');

        const length = parseFloat(normalize(lengthMatch[1]));
        const width = parseFloat(normalize(widthMatch[1]));

        if (isNaN(length) || isNaN(width) || length <= 0 || width <= 0) {
        throw new Error("Некорректные размеры рулона.");
        }

        console.log(`Извлеченная длина: ${length}, ширина: ${width}`); // Для отладки
        return +(length * width).toFixed(2);
    }

    throw new Error("Не удалось определить размеры рулона из PDF.");
    }

    async function calculate() {
      const areaInput = document.getElementById('area').value;
      const pdfUrl = document.getElementById('material').value;
      const resultDiv = document.getElementById('result');

      if (!areaInput || areaInput <= 0) {
        resultDiv.innerHTML = '<p class="text-red-600 font-medium fade-in">Введите корректную площадь.</p>';
        return;
      }

      try {
        const text = await fetchPDFText(pdfUrl);
        const rollArea = extractRollArea(text);
        const area = parseFloat(areaInput);
        const requiredArea = area * 1.15;
        const rollsNeeded = Math.ceil(requiredArea / rollArea);

        resultDiv.innerHTML = `
          <p class="text-green-600 font-semibold text-lg fade-in">Необходимо: ${rollsNeeded} рулон(ов)</p>
          <p class="fade-in text-sm text-gray-700">Площадь с запасом 15%: ${requiredArea.toFixed(2)} м²</p>
          <p class="fade-in text-sm text-gray-700">Площадь одного рулона: ${rollArea.toFixed(2)} м²</p>
        `;
      } catch (err) {
        resultDiv.innerHTML = `<p class="text-red-600 font-medium fade-in">Ошибка: ${err.message}</p>`;
      }
    }

    async function renderPDF() {
      const url = document.getElementById('material').value;
      const canvas = document.getElementById('pdf-canvas');
      const context = canvas.getContext('2d');

      try {
        pdfDoc = await pdfjsLib.getDocument(url).promise;
        totalPages = pdfDoc.numPages;
        currentPage = 1;
        document.getElementById('page-count').textContent = totalPages;
        document.getElementById('pdf-controls').classList.remove('hidden');
        canvas.classList.remove('hidden');
        await renderPage(currentPage);
      } catch (err) {
        alert("Ошибка загрузки PDF: " + err.message);
      }
    }

    async function renderPage(pageNum) {
      const canvas = document.getElementById('pdf-canvas');
      const context = canvas.getContext('2d');

      const page = await pdfDoc.getPage(pageNum);
      const viewport = page.getViewport({ scale: 1.3 }); // адаптивный масштаб

      canvas.height = viewport.height;
      canvas.width = viewport.width;

      await page.render({
        canvasContext: context,
        viewport
      }).promise;

      document.getElementById('page-num').textContent = pageNum;
    }

    function prevPage() {
      if (currentPage <= 1) return;
      currentPage--;
      renderPage(currentPage);
    }

    function nextPage() {
      if (currentPage >= totalPages) return;
      currentPage++;
      renderPage(currentPage);
    }
  </script>
</body>
</html>
